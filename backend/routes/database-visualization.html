<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peak 1031 Database Structure Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .table-info {
            background-color: #e3f2fd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
        }
        .issue {
            background-color: #ffebee;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #f44336;
        }
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        code {
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Peak 1031 Exchange Database Structure</h1>
        
        <div class="section">
            <h2>Database Overview</h2>
            <p>Your database consists of <strong>9 main tables</strong> with complex relationships:</p>
            <ul>
                <li><strong>PostgreSQL</strong> database hosted on <strong>Supabase</strong></li>
                <li>Mix of user authentication, business data, and audit trails</li>
                <li>Integration with <strong>PracticePanther</strong> for contact and matter synchronization</li>
            </ul>
        </div>

        <div class="section">
            <h2>Visual Database Schema</h2>
            <div class="mermaid">
erDiagram
    USERS ||--o{ EXCHANGES : "coordinates"
    USERS ||--o{ TASKS : "assigned_to"
    USERS ||--o{ DOCUMENTS : "uploads"
    USERS ||--o{ MESSAGES : "sends"
    USERS ||--o{ AUDIT_LOGS : "creates"
    USERS ||--o{ EXCHANGE_PARTICIPANTS : "participates"
    
    CONTACTS ||--o{ EXCHANGES : "owns"
    CONTACTS ||--o{ EXCHANGE_PARTICIPANTS : "participates"
    
    EXCHANGES ||--o{ TASKS : "contains"
    EXCHANGES ||--o{ DOCUMENTS : "has"
    EXCHANGES ||--o{ MESSAGES : "contains"
    EXCHANGES ||--o{ EXCHANGE_PARTICIPANTS : "has"
    
    DOCUMENTS ||--o{ MESSAGES : "attached_to"
    
    PRACTICEPARTNERSYNC ||--|| CONTACTS : "syncs"
    PRACTICEPARTNERSYNC ||--|| EXCHANGES : "syncs"

    USERS {
        uuid id PK
        string email UK
        string password_hash
        string role
        string first_name
        string last_name
        string phone
        boolean is_active
        boolean two_fa_enabled
        string two_fa_secret
        timestamp last_login
        timestamp created_at
        timestamp updated_at
    }
    
    CONTACTS {
        uuid id PK
        string pp_contact_id UK
        string first_name
        string last_name
        string email
        string phone
        string company
        string address
        jsonb pp_data
        timestamp last_sync_at
        timestamp created_at
        timestamp updated_at
    }
    
    EXCHANGES {
        uuid id PK
        string pp_matter_id
        string name
        string exchange_name
        uuid client_id FK
        uuid coordinator_id FK
        string status
        string priority
        date identification_date
        date closing_date
        decimal relinquished_amount
        string relinquished_property
        string replacement_property
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }
    
    EXCHANGE_PARTICIPANTS {
        uuid id PK
        uuid exchange_id FK
        uuid user_id FK
        uuid contact_id FK
        string role
        jsonb permissions
        timestamp created_at
        timestamp updated_at
    }
    
    TASKS {
        uuid id PK
        uuid exchange_id FK
        string title
        text description
        string priority
        string status
        uuid assigned_to FK
        uuid created_by FK
        date due_date
        timestamp completed_at
        string pp_task_id
        timestamp created_at
        timestamp updated_at
    }
    
    DOCUMENTS {
        uuid id PK
        uuid exchangeId FK
        string originalFilename
        string storedFilename
        string filePath
        bigint fileSize
        string mimeType
        uuid uploadedBy FK
        string category
        boolean pinRequired
        string pinHash
        timestamp created_at
        timestamp updated_at
    }
    
    MESSAGES {
        uuid id PK
        uuid exchange_id FK
        uuid sender_id FK
        text content
        string message_type
        uuid attachment_id FK
        jsonb read_by
        timestamp created_at
        timestamp updated_at
    }
    
    AUDIT_LOGS {
        uuid id PK
        uuid user_id FK
        string action
        string entity_type
        uuid entity_id
        jsonb details
        string ip_address
        string user_agent
        timestamp created_at
    }
    
    PRACTICEPARTNERSYNC {
        uuid id PK
        string sync_type
        string status
        jsonb sync_data
        text error_message
        timestamp started_at
        timestamp completed_at
        timestamp created_at
    }
            </div>
        </div>

        <div class="section">
            <h2>What's In Your Database</h2>
            
            <div class="table-info">
                <h3>1. EXCHANGES (Core Business Entity)</h3>
                <p>The heart of your system - 1031 exchange transactions</p>
                <ul>
                    <li>Tracks exchange lifecycle: PENDING → 45D → 180D → COMPLETED/TERMINATED</li>
                    <li>Links to client (via CONTACTS, not USERS - <span style="color: red;">PROBLEM!</span>)</li>
                    <li>Assigned to coordinators (USERS table)</li>
                    <li>Contains property details, amounts, dates</li>
                </ul>
            </div>

            <div class="table-info">
                <h3>2. CONTACTS (External Data)</h3>
                <p>Synchronized from PracticePanther</p>
                <ul>
                    <li>Client information from external system</li>
                    <li>NO direct link to USERS table</li>
                    <li>Owns exchanges through client_id</li>
                </ul>
            </div>

            <div class="table-info">
                <h3>3. TASKS</h3>
                <p>Todo items within exchanges</p>
                <ul>
                    <li>Assigned to users (coordinators/admins)</li>
                    <li>Priority levels: LOW, MEDIUM, HIGH, URGENT</li>
                    <li>Status tracking: PENDING, IN_PROGRESS, COMPLETED</li>
                    <li>Can sync with PracticePanther tasks</li>
                </ul>
            </div>

            <div class="table-info">
                <h3>4. MESSAGES</h3>
                <p>Real-time chat within exchanges</p>
                <ul>
                    <li>Exchange-specific conversations</li>
                    <li>Sent by USERS (authenticated accounts)</li>
                    <li>Read receipts tracking (JSON)</li>
                    <li>Can have document attachments</li>
                </ul>
            </div>

            <div class="table-info">
                <h3>5. DOCUMENTS</h3>
                <p>File management system</p>
                <ul>
                    <li>Exchange-related documents</li>
                    <li>PIN protection capability</li>
                    <li>Categorization system</li>
                    <li>Tracks uploader (USER)</li>
                </ul>
            </div>

            <div class="table-info">
                <h3>6. USERS</h3>
                <p>Authentication & authorization</p>
                <ul>
                    <li>5 roles: admin, coordinator, client, third_party, agency</li>
                    <li>2FA support</li>
                    <li>Login credentials</li>
                    <li>Activity tracking</li>
                </ul>
            </div>

            <div class="table-info">
                <h3>7. EXCHANGE_PARTICIPANTS</h3>
                <p>Flexible participant linking</p>
                <ul>
                    <li>Links either USERS or CONTACTS to exchanges</li>
                    <li>Role-based permissions</li>
                    <li>Allows multiple participants per exchange</li>
                </ul>
            </div>

            <div class="table-info">
                <h3>8. AUDIT_LOGS</h3>
                <p>Complete activity tracking</p>
                <ul>
                    <li>Records all system actions</li>
                    <li>User attribution</li>
                    <li>IP and user agent tracking</li>
                    <li>Detailed change logs (JSON)</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>Critical Issues</h2>
            
            <div class="issue">
                <h3>🔴 Major Problem: Users Can't Access Their Exchanges</h3>
                <p>The biggest issue in your database:</p>
                <ul>
                    <li>USERS table (for login) has NO link to CONTACTS table</li>
                    <li>EXCHANGES are owned by CONTACTS, not USERS</li>
                    <li>When a client logs in, system can't find their exchanges!</li>
                </ul>
                <p><strong>Impact:</strong> Clients logging in see no exchanges even if they have them</p>
            </div>

            <div class="issue">
                <h3>⚠️ Data Duplication Risk</h3>
                <ul>
                    <li>Same person might exist in both USERS and CONTACTS</li>
                    <li>Email matching is unreliable (contacts email can be null)</li>
                    <li>No unique constraint preventing duplicates</li>
                </ul>
            </div>

            <div class="issue">
                <h3>⚠️ Inconsistent Naming</h3>
                <ul>
                    <li>Mix of camelCase (exchangeId) and snake_case (client_id)</li>
                    <li>Makes queries and joins error-prone</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>Data Flow Visualization</h2>
            <div class="mermaid">
flowchart LR
    PP[PracticePanther] -->|Sync| CONTACTS
    PP -->|Sync| EXCHANGES
    
    USER[User Login] -->|Auth| USERS
    USERS -->|❌ No Link| CONTACTS
    
    CONTACTS -->|Owns| EXCHANGES
    USERS -->|Coordinates| EXCHANGES
    
    EXCHANGES -->|Contains| TASKS
    EXCHANGES -->|Has| DOCUMENTS
    EXCHANGES -->|Contains| MESSAGES
    
    style PP fill:#ffd93d
    style USER fill:#4fc3f7
    style USERS fill:#81c784
    style CONTACTS fill:#ffb74d
    style EXCHANGES fill:#9575cd
            </div>
        </div>

        <div class="section">
            <h2>Quick Stats</h2>
            <ul>
                <li><strong>9 tables total</strong> (including PracticePartnerSync)</li>
                <li><strong>5 user roles</strong>: admin, coordinator, client, third_party, agency</li>
                <li><strong>6 exchange statuses</strong>: PENDING, 45D, 180D, COMPLETED, TERMINATED, ON_HOLD</li>
                <li><strong>External integration</strong>: PracticePanther for contacts/matters</li>
                <li><strong>Mixed architecture</strong>: Some data from external sync, some native</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            er: {
                useMaxWidth: true,
                layoutDirection: 'TB'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>