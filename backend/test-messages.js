require('dotenv').config();
const supabaseService = require('./services/supabase');
const databaseService = require('./services/database');

async function testMessages() {
  try {
    const exchangeId = 'ba7865ac-da20-404a-b609-804d15cb0467';
    
    console.log('🔍 Checking messages for exchange:', exchangeId);
    console.log('='.repeat(60));
    
    // Get messages for this exchange using database service
    const messages = await databaseService.getMessages({
      where: { exchangeId },
      orderBy: { column: 'created_at', ascending: false }
    });
    
    console.log(`\n📬 Found ${messages ? messages.length : 0} messages in the database\n`);
    
    if (messages && messages.length > 0) {
      console.log('Messages:');
      console.log('---------');
      messages.forEach((msg, index) => {
        console.log(`\nMessage ${index + 1}:`);
        console.log('  ID:', msg.id);
        console.log('  Content:', msg.content);
        console.log('  Sender ID:', msg.sender_id);
        console.log('  Created:', new Date(msg.created_at).toLocaleString());
        console.log('  Type:', msg.message_type || 'text');
        if (msg.attachment_id) {
          console.log('  Has Attachment: Yes');
        }
      });
    } else {
      console.log('❌ No messages found for this exchange');
      console.log('\nThis means the messages you see in the UI are NOT real.');
      console.log('They might be:');
      console.log('  1. Mock data generated by the frontend');
      console.log('  2. Hardcoded demo messages');
      console.log('  3. Generated on-the-fly for demonstration');
    }
    
    // Check if exchange has a chat room
    console.log('\n' + '='.repeat(60));
    console.log('📡 Checking exchange chat configuration...');
    
    const exchange = await databaseService.getExchangeById(exchangeId);
    
    if (exchange) {
      console.log('  Chat ID:', exchange.exchange_chat_id || exchange.exchangeChatId || 'Not set');
      console.log('  Chat Enabled:', exchange.chat_enabled !== false ? 'Yes' : 'No');
    }
    
  } catch (error) {
    console.error('❌ Error:', error);
  }
}

testMessages().then(() => {
  console.log('\n✅ Test complete');
  process.exit(0);
}).catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});